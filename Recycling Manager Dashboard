import React, { useState, useEffect, useMemo } from 'react';
import { 
  Trophy, 
  Users, 
  BarChart3, 
  Search, 
  RefreshCw, 
  Leaf, 
  AlertTriangle, 
  Smile, 
  Share2, 
  X, 
  Check, 
  ExternalLink, 
  LayoutGrid, 
  ListOrdered,
  Sparkles,
  Volume2,
  Loader2,
  Scale
} from 'lucide-react';

// --- API CONFIGURATION ---
const apiKey = ""; // Runtime provided key
const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
const TTS_MODEL = "gemini-2.5-flash-preview-tts";

/**
 * MOCK DATA GENERATION
 */
const SKILLS = ["Plastic Polymer Sorting", "Hazmat Protocol", "Lean Manufacturing", "OSHA Compliance", "Shift Management", "Conveyor Maintenance"];
const NAMES = ["Jordan Smith", "Casey Rivers", "Morgan Steel", "Riley Forge", "Taylor Green", "Quinn Vance", "Alex Stone", "Skyler Brooks", "Charlie Grant", "Sam Vale"];

const generateMockData = () => {
  return Array.from({ length: 40 }, (_, i) => {
    const crisis = Math.floor(Math.random() * 45) + 55;
    const sust = Math.floor(Math.random() * 50) + 50;
    const motiv = Math.floor(Math.random() * 60) + 40;
    const composite = parseFloat(((crisis * 0.4) + (sust * 0.3) + (motiv * 0.3)).toFixed(1));

    return {
      id: i + 1,
      name: NAMES[i % NAMES.length] + " " + (i + 101),
      experience: Math.floor(Math.random() * 12) + 3,
      primarySkill: SKILLS[i % SKILLS.length],
      email: `candidate.${i + 1}@recycle-corp.com`,
      scores: { crisis, sustainability: sust, motivation: motiv },
      composite,
      status: composite > 85 ? 'Shortlisted' : composite > 70 ? 'Under Review' : 'Rejected'
    };
  });
};

// --- GEMINI API HELPERS ---

async function fetchWithRetry(url, options, retries = 5) {
  for (let i = 0; i < retries; i++) {
    try {
      const response = await fetch(url, options);
      if (response.ok) return await response.json();
      if (response.status !== 429 && response.status < 500) break;
    } catch (e) {
      if (i === retries - 1) throw e;
    }
    await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
  }
  throw new Error("Failed to connect to Gemini API after multiple retries.");
}

/**
 * Converts PCM16 (L16) audio data to a playable WAV Blob
 */
function pcmToWav(pcmBase64, sampleRate = 24000) {
  const binaryString = atob(pcmBase64);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }

  const wavHeader = new ArrayBuffer(44);
  const view = new DataView(wavHeader);

  view.setUint32(0, 0x52494646, false); // "RIFF"
  view.setUint32(4, 36 + len, true);
  view.setUint32(8, 0x57415645, false); // "WAVE"
  view.setUint32(12, 0x666d7420, false); // "fmt "
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true); // PCM - Integer
  view.setUint16(22, 1, true); // Mono
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  view.setUint32(36, 0x64617461, false); // "data"
  view.setUint32(40, len, true);

  return new Blob([wavHeader, bytes], { type: 'audio/wav' });
}

// --- UI COMPONENTS ---

const Paper = ({ children, className = "" }) => (
  <div className={`bg-white rounded-lg border border-gray-200 shadow-sm ${className}`}>
    {children}
  </div>
);

const Badge = ({ children, color = "gray" }) => {
  const colors = {
    green: "bg-emerald-50 text-emerald-700 border-emerald-100",
    blue: "bg-blue-50 text-blue-700 border-blue-100",
    red: "bg-red-50 text-red-700 border-red-100",
    yellow: "bg-amber-50 text-amber-700 border-amber-100",
    gray: "bg-gray-50 text-gray-600 border-gray-100",
  };
  return (
    <span className={`px-2 py-0.5 rounded text-[11px] font-bold uppercase tracking-wider border ${colors[color]}`}>
      {children}
    </span>
  );
};

const Progress = ({ value, color = "blue" }) => (
  <div className="w-full bg-gray-100 rounded-full h-2">
    <div 
      className={`h-2 rounded-full transition-all duration-500 ${color === 'red' ? 'bg-red-500' : color === 'green' ? 'bg-emerald-500' : 'bg-blue-500'}`} 
      style={{ width: `${value}%` }} 
    />
  </div>
);

// --- MAIN APPLICATION ---

export default function App() {
  const [candidates, setCandidates] = useState([]);
  const [search, setSearch] = useState("");
  const [activeTab, setActiveTab] = useState('leaderboard');
  const [selected, setSelected] = useState(null);
  const [sort, setSort] = useState({ key: 'composite', dir: 'desc' });
  const [shared, setShared] = useState(false);

  // AI State
  const [aiSummary, setAiSummary] = useState("");
  const [aiComparison, setAiComparison] = useState("");
  const [isAiLoading, setIsAiLoading] = useState(false);
  const [isTtsLoading, setIsTtsLoading] = useState(false);
  const [isComparisonLoading, setIsComparisonLoading] = useState(false);

  useEffect(() => {
    setCandidates(generateMockData());
  }, []);

  const sortedData = useMemo(() => {
    let filtered = candidates.filter(c => 
      c.name.toLowerCase().includes(search.toLowerCase()) || 
      c.primarySkill.toLowerCase().includes(search.toLowerCase())
    );
    
    return filtered.sort((a, b) => {
      const aVal = sort.key.includes('.') ? a.scores[sort.key.split('.')[1]] : a[sort.key];
      const bVal = sort.key.includes('.') ? b.scores[sort.key.split('.')[1]] : b[sort.key];
      return sort.dir === 'desc' ? bVal - aVal : aVal - bVal;
    });
  }, [candidates, search, sort]);

  const top10 = sortedData.slice(0, 10);

  const handleSort = (key) => {
    setSort(prev => ({ key, dir: prev.key === key && prev.dir === 'desc' ? 'asc' : 'desc' }));
  };

  // --- ✨ GEMINI AI LOGIC ---

  const generateAiSummary = async (candidate) => {
    setIsAiLoading(true);
    setAiSummary("");
    try {
      const prompt = `Analyze this recycling manager candidate for a plant manager: 
      Name: ${candidate.name}
      Skill: ${candidate.primarySkill}
      Scores: Crisis(${candidate.scores.crisis}/100), Sustainability(${candidate.scores.sustainability}/100), Team Motivation(${candidate.scores.motivation}/100).
      
      Provide a punchy 2-sentence hiring recommendation. Finish with a one-word 'Verdict'.`;

      const result = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: "You are a direct, professional industrial recruiter." }] }
          })
        }
      );

      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiSummary(text || "Analysis unavailable.");
    } catch (err) {
      setAiSummary("Connection error.");
    } finally {
      setIsAiLoading(false);
    }
  };

  const generateAiComparison = async (candidate) => {
    setIsComparisonLoading(true);
    setAiComparison("");
    try {
      const avgCrisis = candidates.reduce((a, b) => a + b.scores.crisis, 0) / candidates.length;
      const prompt = `Compare ${candidate.name} (Crisis: ${candidate.scores.crisis}) against the pool average (Crisis: ${avgCrisis.toFixed(1)}). 
      Identify one specific operational advantage this candidate brings. Max 20 words.`;

      const result = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }]
          })
        }
      );

      const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
      setAiComparison(text || "Comparison unavailable.");
    } catch (err) {
      setAiComparison("Error fetching comparison.");
    } finally {
      setIsComparisonLoading(false);
    }
  };

  const speakSummary = async () => {
    if (!aiSummary) return;
    setIsTtsLoading(true);
    try {
      const result = await fetchWithRetry(
        `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            contents: [{ parts: [{ text: `Say clearly: ${aiSummary}` }] }],
            generationConfig: { 
              responseModalities: ["AUDIO"],
              speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Aoede" } } } 
            }
          })
        }
      );

      const base64Data = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      if (base64Data) {
        const audioBlob = pcmToWav(base64Data, 24000);
        const url = URL.createObjectURL(audioBlob);
        const audio = new Audio(url);
        audio.play();
      }
    } catch (err) {
      console.error("TTS Error", err);
    } finally {
      setIsTtsLoading(false);
    }
  };

  const handleShare = () => {
    setShared(true);
    const textToCopy = `${selected.name} (${selected.composite}%): ${aiSummary || 'No AI summary generated.'}`;
    const el = document.createElement('textarea');
    el.value = textToCopy;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    setTimeout(() => setShared(false), 2000);
  };

  return (
    <div className="min-h-screen bg-[#f8f9fa] p-4 md:p-8 font-sans text-gray-800">
      <div className="max-w-6xl mx-auto space-y-6">
        
        {/* Header */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
          <div>
            <h1 className="text-2xl font-bold flex items-center gap-2">
              <Leaf className="text-emerald-600" size={28} />
              Recycling Manager Selection
            </h1>
            <p className="text-sm text-gray-500">Intelligent Production Line Ranking</p>
          </div>
          <div className="flex items-center gap-3">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={16} />
              <input 
                className="pl-9 pr-4 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 outline-none w-64 bg-white"
                placeholder="Filter candidates..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
              />
            </div>
            <button 
              onClick={() => setCandidates(generateMockData())}
              className="p-2 text-gray-500 hover:bg-gray-100 rounded-md transition-colors"
              title="Refresh Pool"
            >
              <RefreshCw size={20} />
            </button>
          </div>
        </div>

        {/* Tab Selection */}
        <div className="flex border-b border-gray-200">
          <button 
            onClick={() => setActiveTab('leaderboard')}
            className={`px-4 py-2 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${activeTab === 'leaderboard' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
          >
            <ListOrdered size={18} /> Rankings
          </button>
          <button 
            onClick={() => setActiveTab('heatmap')}
            className={`px-4 py-2 text-sm font-medium flex items-center gap-2 border-b-2 transition-colors ${activeTab === 'heatmap' ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
          >
            <LayoutGrid size={18} /> Performance Grid
          </button>
        </div>

        {/* List Views */}
        {activeTab === 'leaderboard' ? (
          <Paper className="overflow-hidden">
            <div className="overflow-x-auto">
              <table className="w-full text-sm text-left">
                <thead className="bg-gray-50 text-gray-600 border-b">
                  <tr>
                    <th className="px-6 py-4">Rank</th>
                    <th className="px-6 py-4">Candidate</th>
                    <th className="px-6 py-4">Primary Skill</th>
                    <th className="px-6 py-4 text-center">Composite</th>
                    <th className="px-6 py-4 text-right">Details</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {top10.map((c, i) => (
                    <tr key={c.id} className="hover:bg-gray-50 transition-colors">
                      <td className="px-6 py-4">
                        {i === 0 ? <Trophy className="text-amber-500" size={20} /> : <span className="text-gray-400">#{i + 1}</span>}
                      </td>
                      <td className="px-6 py-4 font-bold">{c.name}</td>
                      <td className="px-6 py-4"><Badge color="blue">{c.primarySkill}</Badge></td>
                      <td className="px-6 py-4 text-center font-black text-blue-700">{c.composite}</td>
                      <td className="px-6 py-4 text-right">
                        <button onClick={() => { setSelected(c); setAiSummary(""); setAiComparison(""); }} className="p-2 hover:bg-blue-50 text-blue-600 rounded-md">
                          <ExternalLink size={18}/>
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </Paper>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {sortedData.slice(0, 15).map(c => (
              <Paper key={c.id} className="p-4 cursor-pointer hover:border-blue-300" onClick={() => { setSelected(c); setAiSummary(""); setAiComparison(""); }}>
                <div className="flex justify-between items-start mb-3">
                  <h3 className="font-bold text-gray-900">{c.name}</h3>
                  <span className="text-xs font-bold text-blue-600">{c.composite}%</span>
                </div>
                <div className="space-y-2">
                  <Progress value={c.scores.crisis} color="red" />
                  <Progress value={c.scores.sustainability} color="green" />
                  <Progress value={c.scores.motivation} color="blue" />
                </div>
              </Paper>
            ))}
          </div>
        )}

        {/* Modal: Detailed AI Profile */}
        {selected && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm">
            <Paper className="w-full max-w-2xl overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-200">
              <div className="p-5 flex justify-between items-center border-b bg-white">
                <div className="flex items-center gap-3">
                   <div className="w-10 h-10 rounded-full bg-blue-700 text-white flex items-center justify-center font-bold">
                    {selected.name.charAt(0)}
                   </div>
                   <div>
                    <h2 className="text-lg font-bold">{selected.name}</h2>
                    <p className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">{selected.primarySkill}</p>
                   </div>
                </div>
                <button onClick={() => setSelected(null)} className="p-2 text-gray-400 hover:text-gray-600"><X size={20}/></button>
              </div>

              <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6 bg-white">
                <div className="space-y-4">
                  <div>
                    <p className="text-[10px] font-bold text-gray-400 uppercase mb-2">Technical Competency</p>
                    <div className="space-y-3">
                      <div>
                        <div className="flex justify-between text-[11px] mb-1"><span>Crisis Management</span><span className="font-bold">{selected.scores.crisis}</span></div>
                        <Progress value={selected.scores.crisis} color="red" />
                      </div>
                      <div>
                        <div className="flex justify-between text-[11px] mb-1"><span>Sustainability</span><span className="font-bold">{selected.scores.sustainability}</span></div>
                        <Progress value={selected.scores.sustainability} color="green" />
                      </div>
                      <div>
                        <div className="flex justify-between text-[11px] mb-1"><span>Team Motivation</span><span className="font-bold">{selected.scores.motivation}</span></div>
                        <Progress value={selected.scores.motivation} color="blue" />
                      </div>
                    </div>
                  </div>
                  
                  <div className="pt-4 border-t border-gray-100">
                    <p className="text-[10px] font-bold text-gray-400 uppercase mb-2">Pool Comparison ✨</p>
                    {isComparisonLoading ? (
                      <div className="flex items-center gap-2 py-2 text-xs text-indigo-500 animate-pulse"><Loader2 size={12} className="animate-spin"/> Calculating bench strength...</div>
                    ) : aiComparison ? (
                      <div className="p-3 bg-indigo-50 rounded-md border border-indigo-100 flex items-start gap-3">
                        <Scale size={16} className="text-indigo-600 mt-1 flex-shrink-0" />
                        <p className="text-[11px] leading-relaxed text-indigo-900">{aiComparison}</p>
                      </div>
                    ) : (
                      <button 
                        onClick={() => generateAiComparison(selected)}
                        className="w-full py-2 border border-dashed border-indigo-300 rounded-md text-[10px] font-bold text-indigo-600 hover:bg-indigo-50 transition-colors"
                      >
                        ✨ Run Market Comparison
                      </button>
                    )}
                  </div>
                </div>

                {/* AI Recruiter Panel */}
                <div className="bg-slate-50 border border-slate-200 rounded-xl p-5 flex flex-col justify-between relative shadow-inner">
                  <div className="mb-4">
                    <div className="flex justify-between items-center mb-3">
                      <span className="text-[9px] font-black text-indigo-600 flex items-center gap-1.5 tracking-tighter uppercase">
                        <Sparkles size={14} /> Gemini Executive Summary
                      </span>
                      {aiSummary && (
                        <button 
                          onClick={speakSummary} 
                          disabled={isTtsLoading}
                          className="p-1.5 bg-white shadow-sm border rounded-full text-indigo-600 hover:text-indigo-800 disabled:opacity-50"
                        >
                          {isTtsLoading ? <Loader2 size={14} className="animate-spin"/> : <Volume2 size={14}/>}
                        </button>
                      )}
                    </div>
                    
                    {isAiLoading ? (
                      <div className="flex flex-col items-center py-10">
                        <Loader2 className="animate-spin text-indigo-500 mb-2" size={24} />
                        <p className="text-[10px] font-bold text-indigo-400">Consulting AI Recruiter...</p>
                      </div>
                    ) : aiSummary ? (
                      <p className="text-xs leading-relaxed text-slate-700 font-medium italic">"{aiSummary}"</p>
                    ) : (
                      <div className="flex flex-col items-center py-10 border-2 border-dashed border-slate-200 rounded-lg">
                        <Sparkles className="text-slate-300 mb-2" size={24} />
                        <p className="text-[10px] text-slate-400 font-bold uppercase mb-3">No analysis generated</p>
                        <button 
                          onClick={() => generateAiSummary(selected)}
                          className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-xs font-bold shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2"
                        >
                          ✨ Generate AI Recommendation
                        </button>
                      </div>
                    )}
                  </div>

                  <div className="flex items-center gap-2 pt-4 border-t border-slate-200">
                    <div className="flex-1">
                      <p className="text-[9px] text-slate-400 font-bold uppercase">Weighted Total</p>
                      <p className="text-xl font-black text-slate-800">{selected.composite}%</p>
                    </div>
                    <Badge color={selected.composite > 85 ? 'green' : 'yellow'}>{selected.status}</Badge>
                  </div>
                </div>
              </div>

              <div className="p-4 bg-white border-t flex gap-3">
                <button 
                  onClick={handleShare}
                  className={`flex-1 flex items-center justify-center gap-2 py-2.5 rounded-lg font-bold text-xs transition-all ${shared ? 'bg-emerald-600 text-white' : 'bg-slate-900 text-white hover:bg-slate-800'}`}
                >
                  {shared ? <Check size={16}/> : <Share2 size={16}/>}
                  {shared ? 'Copied Details' : 'Export Profile'}
                </button>
                <button 
                  onClick={() => setSelected(null)}
                  className="px-6 py-2.5 bg-white border border-slate-200 rounded-lg font-bold text-xs text-slate-600 hover:bg-slate-50"
                >
                  Close
                </button>
              </div>
            </Paper>
          </div>
        )}
      </div>
    </div>
  );
}